# 基础语法 {#base}

“程序 = 算法 + 数据结构”，**数据结构**是信息的载体，而**算法**是完成任务所需要的步骤。两者的构造和使用方法形成了编程语言独特的语法。本章先介绍 R 的基本数据结构，然后介绍条件和循环控制，最后介绍函数的创建与拓展包的使用。

## 基本数据结构

为了表示现实世界的信息，各类编程语言常包含 3 种基本的数据类型：**数值型**，包括整数和浮点数；**字符型**，表示文本信息；**逻辑型**，也常称为布尔值，表示是非判断，如对与错，是与否。在 R 中，除了这些基本数据类型的实现，为了方便计算工作，R 本身还包含了矩阵、数据框和列表等复杂的数据类型，以支持表示各类常用的数据。

### 向量

在 R 中，数据运算常通过向量的形式进行。**向量**是一组同质的信息，如 20 个数字、30 个字符串（与数学术语中的向量类似，但不等同）。单一的信息在此被称为**元素**。**标量**可以看作元素数量为 1 的向量。

接下来我们通过向量元素的数据类型来实际地了解和操作它。

#### 数值

数值应该可以说是最常用的信息表现形式，如人的身高、年龄。在 R 中使用小学学到的阿拉伯表示法即可创建数值，如圆周率 $\pi$：

```{r}
3.14
```

> 此处 `#>` 后显示 R 运行代码后的返回结果，`[1]` 是结果的索引，以辅助用户观测，这里表示结果的第 1 个值是 3.14。

`typeof()` 与 `class()` 是两个对于初学者非常有用的函数，它们可以返回数据的类型信息。

```{r}
typeof(3.14)
class(3.14)
```

在 R 中不需要像其他语言一样区分数值的精度信息，`typeof()` 返回结果为 `double` 提示该值是一个浮点数。

在 R 中，任何所见的事物皆为**对象**，`class()` 返回对象的类信息，此处是 `numeric`（数值）。

我们再来看看如何在 R 中表示整数。借助上述两个工具函数，我们不难发现下面的代码与想象不同。

```{r}
3

typeof(3)
class(3)
```

`typeof()` 与 `class()` 对于 3 的返回结果与 3.14 完全相同！这是因为即便只输入 3，R 也将其作为浮点数对待。

我们可以利用 `identical()` 函数或 `is.integer()` 函数进行检查：

```{r}
identical(3, 3.0)

is.integer(3)
```

返回的结果是后面将介绍的逻辑值，`TRUE` 表示对、`FALSE` 表示错。因此可以判断 `3` 并不是整数。

正确的整数表示方法需要在数字后加 `L` 后缀，如 `3L`。

```{r}
is.integer(3L)

identical(3L, 3)
```

`is.integer()` 函数隶属于 `is.xxx()` 家族，该函数家族用于辅助判断对象是否属于某一类型。读者在 RStudio 中输入 `is.` 后 RStudio 将智能提示有哪些函数的名字以 `is.` 开头。

浮点数和整数都是数值，所以下面的代码都会返回 `TRUE`：

```{r}
is.numeric(3.14)
is.numeric(3L)
```

现实中的数据常成组出现，例如，一组学生的身高。R 使用 `c()` 函数（`c` 为 `combine` 的缩写）对数据进行组合：


```{r}
c(1.70, 1.72, 1.80, 1.66, 1.65, 1.88)
```

这样我们就有了一组身高数据。

利用 R 自带的 `mean()` 和 `sd()` 还是我们可以轻易求取这组数据的均值和标准差：

```{r}
# 均值
mean(c(1.70, 1.72, 1.80, 1.66, 1.65, 1.88))
# 标准差
sd(c(1.70, 1.72, 1.80, 1.66, 1.65, 1.88))
```

上面我们计算时我们重复输入了身高数据，如果在输入时发生了小小的意外，如计算标准差时将 `1.65` 写成了 `1.66`，那么我们分析得就不是同一组数据了！虽然说在上述的简单计算不太可能发生这种情况，但如果存在 100 甚至 1000 个数据的重复输入，依靠人眼判断几乎是必然出错的。

一个解决办法是依赖系统自带的复制粘贴机制，但如果一组数据被上百次重复使用，这种办法也不实际。

正确的解决办法是引入一个符号（Symbol），用该符号**指代**一组数据，然后每次需要使用该数据时，使用符号代替即可。符号在编程语言中也常被称为**变量**，后面我们统一使用该术语。

上述代码块改写为：

```{r}
heights <- c(1.70, 1.72, 1.80, 1.66, 1.65, 1.88)
mean(heights)
sd(heights)
```

`<-` 符号在 R 中称为赋值符号，我们可以将它看作数据的流动方向，这样更方便理解，我们不难猜测到 `->` 的写法也是有效的：

```{r}
c(1.70, 1.72, 1.80, 1.66, 1.65, 1.88) -> heights2
heights2
```

但通常以 `<-` 的写法为主。

另外，`=` 符号与 `<-` 有基本相同的含义，但不常用。如果读者有其他编程语言经验，也可以使用它作为常用赋值符号。两者的区别见本章【**常见问题与方案**】一节。

R 中变量的命名有一些限制，最重要的就是不要以数字开头：

```{r, error=TRUE}
3ab = 3
```

变量命名有 2 点建议：

1. 对于一些临时使用的变量，以简单为主，如 `i`、`j`、`k` 等。
2. 与数据相关的命名，建议与其信息一致，如上面的代码我使用了 `heights`，不然在没有注释的情况下，代码的阅读者无法快速理解你写的程序。

另外，**长变量**的命名通常有 2 个推荐的规则：

1. 骆驼法

以学生身高数据为例，可以写为 `studentHeights`，它遵循 `aBcDeF` 这样的构造方式。

2. 蛇形

以下划线作为分隔符，写为 `student_heights`。

两种写法在 R 中都很常用，读者选择一种即可，**重点在于一个 R 脚本中应当保持变量名命名风格的一致**。

在了解向量和变量后，我们再来学习下向量的计算方式。

假设我们有两组数据，分别以变量 `a` 和 `b` 存储：

```{r}
a <- c(1, 2, 3)
b <- c(4, 5, 6)
```

我们将其堆叠到一起，如图 \@ref(fig:vector-construction)：

```{r vector-construction, fig.height=1, echo=FALSE, fig.cap="向量的直观展示"}
layout(matrix(1:6, byrow = TRUE, ncol = 3))
layout.show(6)
```

当我们将 `a` 与 `b` 相加，结果是什么呢？

```{r}
a + b
```

两个向量之和是向量元素一一相加组成的向量。如果向量的元素不相同，结果又是如何呢？

我们将 `a` 与 `4` 相加看一看，此时向量堆叠如图 \@ref(fig:vector-add) 所示：

```{r vector-add, fig.height=1, echo=FALSE, fig.cap="向量不等长图示"}
layout(matrix(c(1:4, 0, 0), byrow = TRUE, ncol = 3))
layout.show(4)
```

```{r}
a + 4
```

上述结果与 `a + c(4, 4, 4)` 相同：

```{r}
a + c(4, 4, 4)
```

因此，如果向量不等长时，短向量会通过重复与长向量先对齐（如图 \@ref(fig:vector-align)），然后再相加。

```{r vector-align, fig.height=1, echo=FALSE, fig.cap="向量对齐"}
layout(matrix(c(1:4, 4, 4), byrow = TRUE, ncol = 3))
layout.show(4)
```

注意，此过程中，长向量会保持不变，如果出现短向量重复后无法对齐的情况，多余的部分将被扔掉，R 返回结果的同时会抛出一个警告信息。

```{r, warning=TRUE}
c(1, 2, 3) + c(4, 5)
# 上面的加法等价于 c(1, 2, 3) + c(4, 5, 4)
```

整个过程称为**向量化运算**。除了加法，其他任何向量（几何）运算方式都相同。


```{r}
# 想减
a - b
# 相除
a / b
# 相乘
a * b
# 整除
a %/% b
# 取余数
a %% b
# 平方
a ^ 2
# 取对数
log(a, base = 2)
```

**向量化运算**的本质是成对的向量元素运算操作。这个特性让 R 在处理数据时非常方便，无论向量元素的个数是多少，在运算时我们都可以将其作为标量对待。

例如，计算数据 `heights` 的均值和标准差，这里我们直接通过公式而不是 R 自带的函数进行计算：

$$
\mu = \frac{\sum x_i}{n}
$$

$$
sd = \sqrt\frac{\sum(x_i - \mu)^2}{n - 1}
$$

> `sd` 的计算中使用的是 `n-1` 而不是 `n` 的原因是我们计算的是**样本**标准差。 

实际操作如下：

```{r}
# 先计算均值
heightsMean <- sum(heights) / length(heights)
heightsMean
# 计算标准差
heightsSD <- sqrt( sum( (heights - heightsMean)^ 2) / (length(heights) - 1) )
heightsSD
```

将结果与 R 函数计算结果对比：

```{r}
mean(heights)
sd(heights)
```

注意，上述我们使用了 R 的一些其他工具函数，`length()` 用来获取向量的长度，而 `sum()` 用来获取向量之和，`sqrt()` 用来计算开方。

初学者可能对于计算中使用的一些计算函数感到陌生，这是**非常非常非常正常**的，我个人也无法记得所有 R 提供的函数，编程是一门实践课程，读者需要通过使用去熟悉，而无法通过死记硬背掌握。在想要使用自己不知道的函数时，这里有几点建议：

1. 猜测函数名。R 的函数命名方式是有规律可循的，且大体有对应的英文含义，读者不妨先尝试猜一猜函数名，看看是否真的有。
2. 使用 R 的文档系统。R 的文档系统非常丰富，读者可以在 R 控制台 `?numeric` 来获取关于 `numeric` 的相关信息。而 `??numeric` 可以进行更为深度的搜索。学会读和理解函数文档是掌握 R 必备的技能。
3. 使用搜索引擎。（初学者）遇到的问题基本都会有人遇到，R 的用户众多，各个博客和论坛都记录了关于 R 的使用和问题讨论，在上述 2 点无法解决问题时，读者不妨多使用搜索引擎查找相关资料。


#### 字符串

#### 因子

#### 逻辑值
 
#### 向量构造 
 
### 矩阵

### 数据框

### 列表

## 控制结构与循环

## 函数与函数式编程

## 拓展包安装与使用

## 常见问题与方案

除了本节目前罗列的问题，读者在学习本章内容时遇到的其他问题都可以通过 [GitHub Issue](https://github.com/ShixiangWang/geek-r-tutorial/issues) 提出和进行讨论。如果读者提出的是通性问题，将增补到该节。

### `=` 与 `<-` 的区别